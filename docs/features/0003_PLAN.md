# Fix Broken Features: Save/Use Mappings, Save/Load Analysis, Compare Full

## Context
Three previously working features have stopped functioning, likely due to changes in how file mappings and tabs are tracked. The features are:

1. **Save Mappings and Use Mappings**: Allows users to save column and sheet mappings to a `.pkl` file and later apply them to new BOQ files with similar structure.
2. **Save Analysis and Load Analysis**: Allows users to save complete analysis state (dataframe, categorization results, offer info) to a `.pkl` file and restore it later.
3. **Compare Full**: Allows users to compare a categorized master BOQ dataset with a new comparison file.

All three features rely on proper tracking of `file_mapping` objects across tabs using both `self.controller.current_files` and `self.tab_id_to_file_mapping` dictionaries.

## Targeted Files

- `ui/main_window.py`: Contains all three feature implementations
  - `_save_mapping_for_categorized_data()` (lines 4798-4841): Saves mapping data
  - `_use_mapping()` (lines 3409-3432): Loads mapping and initiates workflow
  - `_open_excel_file_with_mapping()` (lines 3434-3455): Opens file with saved mapping
  - `_apply_saved_mapping()` (lines 3512-3545): Applies saved mapping to file_mapping
  - `_save_analysis_for_categorized_data()` (lines 4843-4897): Saves complete analysis
  - `_load_analysis()` (lines 3351-3407): Loads saved analysis
  - `_compare_full()` (lines 2360-2607): Main comparison workflow
  - `_compare_full_from_categorized_data()` (lines 4976-5000): Initiates comparison from categorized data tab
  - `_on_categorization_complete()` (lines 2184-2260): Handles categorization completion and file_mapping storage
  - `_on_mapping_processing_complete()` (lines 3546-3598): Handles mapping workflow completion

## Root Causes

### Issue 1: Save Mappings - Tab/File Mapping Lookup Failure
**Problem**: `_save_mapping_for_categorized_data()` tries to find `file_mapping` by matching `file_data['file_mapping'].tab` attribute with `current_tab_path`, but:
- After categorization completes and tab content is replaced with `_show_final_categorized_data()`, the tab reference in `file_mapping.tab` may become stale or mismatched
- The lookup relies on string comparison of tab IDs which may not match if tab was recreated or tab ID format changed

**Location**: Lines 4814-4821

### Issue 2: Use Mappings - File Mapping Not Properly Tracked
**Problem**: The `_use_mapping()` workflow processes files but may not properly store the resulting `file_mapping` in both tracking dictionaries:
- File mapping is stored in `tab_id_to_file_mapping` in `_on_mapping_processing_complete()` (line 3587)
- However, if the tab reference changes or the tracking gets out of sync, subsequent operations fail
- The `_apply_saved_mapping()` may not preserve all necessary mapping data structures

**Location**: Lines 3409-3600

### Issue 3: Load Analysis - Mock File Mapping Not Integrated
**Problem**: `_load_analysis()` creates a `MockFileMapping` object (lines 3377-3385) but:
- This mock object doesn't have a real `file_mapping` structure with sheets, column_mappings, etc.
- The file_mapping is not stored in `tab_id_to_file_mapping`, which `_compare_full()` requires
- Other features like "Save Mappings" and "Compare Full" can't find the file_mapping because it doesn't exist or isn't tracked

**Location**: Lines 3351-3407

### Issue 4: Compare Full - Missing File Mapping Lookup
**Problem**: `_compare_full_from_categorized_data()` tries to find file_data and calls `_compare_full(tab)`, but:
- `_compare_full()` expects to find `file_mapping` in `tab_id_to_file_mapping` using `current_tab_id` (line 2373)
- If the categorized data tab doesn't have its file_mapping stored there, the lookup fails
- The function tries to find file_data in `controller.current_files` but may not ensure `tab_id_to_file_mapping` is also updated

**Location**: Lines 4976-5000 and 2360-2376

## Implementation Steps

### Phase 1: Fix File Mapping Tracking Consistency

1. **Standardize Tab ID Usage**
   - Create helper method `_get_current_tab_id()` that consistently returns tab ID as string
   - Ensure all tab lookups use this helper instead of direct `self.notebook.select()` calls
   - Document expected format (should be consistent across codebase)

2. **Ensure Dual Tracking**
   - Whenever a `file_mapping` is stored in `controller.current_files`, also store it in `tab_id_to_file_mapping`
   - Create helper method `_store_file_mapping_for_tab(tab_id, file_mapping)` that updates both tracking dictionaries
   - Update all locations where file_mapping is stored to use this helper:
     - `_on_processing_complete()` (line 843)
     - `_on_mapping_processing_complete()` (line 3587)
     - `_on_categorization_complete()` (should ensure tab_id_to_file_mapping is updated)

3. **Fix File Mapping Lookup**
   - Create helper method `_get_file_mapping_for_current_tab()` that checks both tracking dictionaries
   - Check `tab_id_to_file_mapping` first, then fall back to `controller.current_files`
   - Update all lookup locations to use this helper:
     - `_save_mapping_for_categorized_data()` (line 4814)
     - `_compare_full_from_categorized_data()` (line 4984)
     - `_save_analysis_for_categorized_data()` (line 4866)

### Phase 2: Fix Save Mappings Feature

4. **Fix Save Mappings Lookup**
   - Update `_save_mapping_for_categorized_data()` to use `_get_file_mapping_for_current_tab()` helper
   - Add fallback to also check `tab_id_to_file_mapping` if current_files lookup fails
   - Ensure `current_sheet_categories` is properly retrieved (may need to store in file_mapping or file_data)
   - Verify that `file_mapping.sheets` exists and has `column_mappings` attribute

5. **Preserve Sheet Categories in File Mapping**
   - Store `current_sheet_categories` in file_mapping or file_data when sheets are categorized
   - Retrieve it from the same location when saving mappings
   - Ensure sheet categories are applied when using saved mappings in `_apply_saved_mapping()`

### Phase 3: Fix Load Analysis Feature

6. **Create Proper File Mapping Structure for Loaded Analysis**
   - Instead of `MockFileMapping`, create a minimal but functional `file_mapping` object that:
     - Has a `sheets` attribute (even if empty or minimal)
     - Has `offer_info` attribute with loaded offer info
     - Has `metadata` attribute with file path from loaded analysis
     - Can be used by other features that expect a file_mapping
   - Store this file_mapping in both `controller.current_files` and `tab_id_to_file_mapping`
   - Ensure the tab has the file_mapping stored before displaying categorized data

7. **Integrate Loaded Analysis with Existing Workflows**
   - When loading analysis, ensure `tab_id_to_file_mapping[current_tab_id] = file_mapping` is set
   - Store `final_dataframe` and `categorization_result` in file_data structure
   - Ensure loaded analysis can be used by "Compare Full" and "Save Mappings" features

### Phase 4: Fix Compare Full Feature

8. **Fix Compare Full File Mapping Lookup**
   - Update `_compare_full_from_categorized_data()` to ensure file_mapping is in `tab_id_to_file_mapping`
   - Before calling `_compare_full(tab)`, verify that `tab_id_to_file_mapping[current_tab_id]` exists
   - If missing, add it by looking up from `controller.current_files`
   - Pass the file_mapping explicitly to `_compare_full()` if needed, or ensure lookup succeeds

9. **Ensure Compare Full Works from Categorized Tabs**
   - Verify that `_compare_full()` can find master file_mapping from categorized data tabs
   - The master file_mapping should be stored in `tab_id_to_file_mapping` when categorization completes
   - Ensure `_on_categorization_complete()` stores file_mapping in `tab_id_to_file_mapping` for the categorized tab

### Phase 5: Testing and Validation

10. **Add Error Handling and Logging**
    - Add comprehensive error handling in all lookup methods
    - Log warnings when file_mapping is not found in expected locations
    - Add debug logging to track file_mapping storage and retrieval

11. **Validate All Workflows**
    - Test Save Mappings from categorized data tab
    - Test Use Mappings with saved mapping file
    - Test Save Analysis from categorized data tab
    - Test Load Analysis and verify all buttons work (Save Mapping, Compare Full, etc.)
    - Test Compare Full from categorized data tab
    - Verify that each feature works regardless of which workflow created the categorized data (normal file open, use mapping, load analysis)

## Algorithm for File Mapping Lookup

The standardized lookup algorithm should be:

```
1. Get current tab ID using helper method
2. Check tab_id_to_file_mapping[current_tab_id]
   - If found, return file_mapping
3. Iterate through controller.current_files
   - Check if file_data['file_mapping'].tab matches current_tab_id (as string)
   - If found, also store in tab_id_to_file_mapping for future lookups
   - Return file_mapping
4. Return None if not found (with warning log)
```

## Notes

- The root issue is inconsistent tracking between `self.controller.current_files` and `self.tab_id_to_file_mapping`
- Some workflows store in one but not the other
- The tab ID format/comparison may have changed, causing lookups to fail
- MockFileMapping in load analysis breaks the assumption that all tabs have a real file_mapping
- All fixes should maintain backward compatibility with existing saved `.pkl` files

