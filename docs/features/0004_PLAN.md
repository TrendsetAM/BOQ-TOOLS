# Fix Column Mapping View Issues

## Context
During the column mapping feature implementation (feature 0001), a reference indicator showing Excel column letters (A, B, C, etc.) was added as the first column in the mapping treeview. However, two issues have been identified:

1. **Double-click functionality broken**: When double-clicking a row to assign a different column mapping, the edit dialog fails because it's trying to match the column letter (A, B, C) instead of the original header name.

2. **Column letters disappear when changing reference row**: When pressing the + or - buttons to change the reference row (header row), the column letters disappear from the treeview, causing problems in further actions. This happens because the refresh method doesn't include the column letter when repopulating the treeview.

## Targeted Files

- `ui/main_window.py`: Contains the column mapping treeview implementation and related handlers
  - `_populate_sheet_tab()` (lines 973-1094): Creates the treeview with 6 columns including "Column" for letters, populates initial data with column letters
  - `_edit_column_mapping()` (lines 1351-1497): Handles double-click to edit column mapping - currently uses `values[0]` which is now the column letter instead of original header
  - `_refresh_single_sheet_tab()` (lines 1292-1349): Refreshes treeview after header row change - missing column letter in repopulation (only inserts 5 values instead of 6)
  - `_reprocess_sheet_with_header_row()` (lines 1174-1290): Calls `_refresh_single_sheet_tab()` after changing header row

## Root Causes

### Issue 1: Double-Click Uses Wrong Column Index
**Problem**: In `_edit_column_mapping()` at line 1359, the code uses `values[0]` to get the column name for matching:
```python
column_name = values[0]
```

However, after feature 0001, the treeview structure changed from:
- Old: `("Original Header", "Mapped Type", "Confidence", "Required", "Actions")` - 5 columns
- New: `("Column", "Original Header", "Mapped Type", "Confidence", "Required", "Actions")` - 6 columns

So `values[0]` now contains the Excel column letter (A, B, C), not the original header. The original header is at `values[1]`. This causes the lookup at lines 1362-1365 to fail because it's searching for a mapping with `original_header == column_letter`, which will never match.

**Location**: Line 1359 in `_edit_column_mapping()`

### Issue 2: Column Letters Missing in Refresh
**Problem**: In `_refresh_single_sheet_tab()` at lines 1339-1345, when repopulating the treeview after a header row change, the code only inserts 5 values:
```python
tree.insert("", tk.END, values=(
    original_header,      # Missing column letter!
    mapped_type,
    f"{confidence:.1%}",
    "Yes" if required else "No",
    actions
), tags=tags)
```

But the treeview expects 6 columns (as defined in `_populate_sheet_tab()` line 1023). The missing first value (column letter) causes the column alignment to shift, making all subsequent columns display incorrectly and the "Column" column to appear empty.

**Location**: Lines 1339-1345 in `_refresh_single_sheet_tab()`

## Implementation Steps

### Fix 1: Update Double-Click Handler to Use Correct Column Index

1. **Update `_edit_column_mapping()` method**
   - Change line 1359 from `column_name = values[0]` to `column_name = values[1]`
   - The original header is now at index 1 (second column) instead of index 0
   - Add a comment explaining the column structure for future maintainability
   - Verify that the lookup logic at lines 1362-1365 will now correctly match mappings by original_header

### Fix 2: Include Column Letter in Treeview Refresh

2. **Update `_refresh_single_sheet_tab()` method**
   - At line 1326, when iterating through `sheet.column_mappings`, extract the `column_index` from each mapping
   - Calculate the column letter using `excel_column_letter()` helper (already imported from `utils.format_utils`)
   - Update the `tree.insert()` call at line 1339 to include the column letter as the first value:
     ```python
     tree.insert("", tk.END, values=(
         column_letter,      # Add this as first value
         original_header,
         mapped_type,
         f"{confidence:.1%}",
         "Yes" if required else "No",
         actions
     ), tags=tags)
     ```
   - Ensure the column letter calculation matches the logic in `_populate_sheet_tab()` (lines 1062-1064)

## Algorithm for Column Letter Calculation

The column letter should be calculated consistently in both methods:

```python
col_index = getattr(mapping, 'column_index', None)
column_letter = excel_column_letter(col_index) if col_index is not None else "--"
```

This matches the implementation in `_populate_sheet_tab()` at lines 1062-1064.

## Notes

- The treeview column structure is: `("Column", "Original Header", "Mapped Type", "Confidence", "Required", "Actions")`
- Column indices in mappings are zero-based (0 = A, 1 = B, etc.)
- The `excel_column_letter()` function in `utils/format_utils.py` handles the conversion from zero-based index to Excel column letter
- Both fixes are minimal and focused - they only correct the index usage and add the missing column letter value
- No changes needed to the treeview column definitions or other parts of the codebase

